import"./modulepreload-polyfill-B5Qt9EMX.js";class b{calculateFrames(e){const i=parseInt(e.startX,10),t=parseInt(e.startY,10),s=parseInt(e.frameWidth,10),a=parseInt(e.frameHeight,10),n=parseInt(e.frameCount,10),h=[];for(let r=0;r<n;r++)h.push({x:i+r*s,y:t,w:s,h:a,anchor:{x:s/2,y:a/2}});return h}}class v{static hexToRgb(e){const i=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return i?{r:parseInt(i[1],16),g:parseInt(i[2],16),b:parseInt(i[3],16)}:null}static process(e,i,t){const s=this.hexToRgb(i);if(!s)return;const a=e.data,{r:n,g:h,b:r}=s,d=t*t;for(let o=0;o<a.length;o+=4){const l=a[o],g=a[o+1],m=a[o+2],c=l-n,u=g-h,f=m-r;c*c+u*u+f*f<=d&&(a[o+3]=0)}}static erode(e,i){if(i<=0)return;const{width:t,height:s,data:a}=e,n=new Uint8ClampedArray(a);for(let h=0;h<s;h++)for(let r=0;r<t;r++){const d=(h*t+r)*4;if(n[d+3]===0)continue;let o=!1;for(let l=-i;l<=i;l++){for(let g=-i;g<=i;g++){if(g===0&&l===0)continue;const m=r+g,c=h+l;if(m>=0&&m<t&&c>=0&&c<s){const u=(c*t+m)*4;if(n[u+3]===0){o=!0;break}}}if(o)break}o&&(a[d+3]=0)}}}class y{constructor(){this.calculator=new b,this.image=null,this.sourceFilename=null,this.frames=[],this.currentFrameIndex=0,this.lastFrameTime=0,this.animationId=null,this.imageInput=document.getElementById("imageInput"),this.inputs={startX:document.getElementById("startX"),startY:document.getElementById("startY"),frameWidth:document.getElementById("frameWidth"),frameHeight:document.getElementById("frameHeight"),frameCount:document.getElementById("frameCount"),fps:document.getElementById("fps"),globalWidth:document.getElementById("globalWidth"),globalHeight:document.getElementById("globalHeight")},this.bgRemoveEnabled=document.getElementById("bgRemoveEnabled"),this.bgRemoveControls=document.getElementById("bgRemoveControls"),this.bgKeyColor=document.getElementById("bgKeyColor"),this.bgKeyColorText=document.getElementById("bgKeyColorText"),this.bgThreshold=document.getElementById("bgThreshold"),this.bgThresholdVal=document.getElementById("bgThresholdVal"),this.bgErode=document.getElementById("bgErode"),this.bgErodeVal=document.getElementById("bgErodeVal"),this.exportBtn=document.getElementById("exportBtn"),this.saveProjectBtn=document.getElementById("saveProjectBtn"),this.loadProjectInput=document.getElementById("loadProjectInput"),this.mainCanvas=document.getElementById("mainCanvas"),this.previewCanvas=document.getElementById("previewCanvas"),this.jsonOutput=document.getElementById("jsonOutput"),this.dropZone=document.getElementById("dropZone"),this.overlayLayer=document.getElementById("overlayLayer"),this.interactionMode=document.getElementById("interactionMode"),this.ctx=this.mainCanvas.getContext("2d"),this.previewCtx=this.previewCanvas.getContext("2d"),this.anchorOverrides={},this.frameOverrides={},this.draggingFrame=null,this.dragStartMouse={x:0,y:0},this.dragStartAnchor={x:0,y:0},this.dragStartFramePos={x:0,y:0},this.init()}init(){this.imageInput.addEventListener("change",e=>this.handleFileSelect(e.target.files[0])),Object.values(this.inputs).forEach(e=>{e.addEventListener("input",()=>this.update())}),this.bgRemoveEnabled.addEventListener("change",()=>{this.bgRemoveControls.style.display=this.bgRemoveEnabled.checked?"flex":"none",this.renderPreview()}),this.bgKeyColor.addEventListener("input",e=>{this.bgKeyColorText.value=e.target.value,this.renderPreview()}),this.bgKeyColorText.addEventListener("input",e=>{this.bgKeyColor.value=e.target.value,this.renderPreview()}),this.bgThreshold.addEventListener("input",e=>{this.bgThresholdVal.textContent=e.target.value,this.renderPreview()}),this.bgErode.addEventListener("input",e=>{this.bgErodeVal.textContent=e.target.value,this.renderPreview()}),this.exportBtn.addEventListener("click",()=>this.exportSpriteSheet()),this.saveProjectBtn.addEventListener("click",()=>this.saveProject()),this.loadProjectInput.addEventListener("change",e=>this.handleLoadProject(e)),this.mainCanvas.addEventListener("mousedown",e=>this.handleCanvasClick(e)),this.mainCanvas.addEventListener("touchstart",e=>{e.touches.length===1&&(this.handleCanvasClick(e.touches[0]),e.preventDefault())},{passive:!1}),window.addEventListener("mousemove",e=>this.handleGlobalMouseMove(e)),window.addEventListener("mouseup",()=>this.handleGlobalMouseUp()),window.addEventListener("touchmove",e=>{this.draggingFrame!==null&&e.touches.length===1&&(this.handleGlobalMouseMove(e.touches[0]),e.preventDefault())},{passive:!1}),window.addEventListener("touchend",()=>this.handleGlobalMouseUp()),this.dropZone.addEventListener("dragover",e=>{e.preventDefault(),this.dropZone.style.backgroundColor="#333"}),this.dropZone.addEventListener("dragleave",e=>{e.preventDefault(),this.dropZone.style.backgroundColor="#222"}),this.dropZone.addEventListener("drop",e=>{e.preventDefault(),this.dropZone.style.backgroundColor="#222",e.dataTransfer.files.length>0&&this.handleFileSelect(e.dataTransfer.files[0])}),this.animate(0)}handleFileSelect(e){if(!e||!e.type.startsWith("image/"))return;this.sourceFilename=e.name;const i=new FileReader;i.onload=t=>{const s=new Image;s.onload=()=>{this.image=s,this.mainCanvas.width=s.width,this.mainCanvas.height=s.height,this.overlayLayer.style.width=s.width+"px",this.overlayLayer.style.height=s.height+"px",this.update()},s.src=t.target.result},i.readAsDataURL(e)}getConfig(){return{startX:parseInt(this.inputs.startX.value)||0,startY:parseInt(this.inputs.startY.value)||0,frameWidth:parseInt(this.inputs.frameWidth.value)||32,frameHeight:parseInt(this.inputs.frameHeight.value)||32,frameCount:parseInt(this.inputs.frameCount.value)||1,fps:parseInt(this.inputs.fps.value)||10,globalWidth:parseInt(this.inputs.globalWidth.value)||64,globalHeight:parseInt(this.inputs.globalHeight.value)||64}}getProjectState(){return{config:this.getConfig(),bgRemoval:{enabled:this.bgRemoveEnabled.checked,keyColor:this.bgKeyColor.value,threshold:this.bgThreshold.value,erode:this.bgErode.value},sourceFilename:this.sourceFilename,anchorOverrides:this.anchorOverrides,frameOverrides:this.frameOverrides}}loadProjectState(e){e.config&&(this.inputs.startX.value=e.config.startX,this.inputs.startY.value=e.config.startY,this.inputs.frameWidth.value=e.config.frameWidth,this.inputs.frameHeight.value=e.config.frameHeight,this.inputs.frameCount.value=e.config.frameCount,this.inputs.fps.value=e.config.fps,this.inputs.globalWidth.value=e.config.globalWidth,this.inputs.globalHeight.value=e.config.globalHeight),e.bgRemoval&&(this.bgRemoveEnabled.checked=e.bgRemoval.enabled,this.bgKeyColor.value=e.bgRemoval.keyColor,this.bgKeyColorText.value=e.bgRemoval.keyColor,this.bgThreshold.value=e.bgRemoval.threshold,this.bgThresholdVal.textContent=e.bgRemoval.threshold,this.bgErode.value=e.bgRemoval.erode||0,this.bgErodeVal.textContent=e.bgRemoval.erode||0,this.bgRemoveControls.style.display=this.bgRemoveEnabled.checked?"flex":"none"),e.sourceFilename&&(this.sourceFilename=e.sourceFilename),e.anchorOverrides&&(this.anchorOverrides=e.anchorOverrides),e.frameOverrides&&(this.frameOverrides=e.frameOverrides),this.update()}update(){const e=this.getConfig();this.frames=this.calculator.calculateFrames(e),this.frames.forEach((i,t)=>{this.frameOverrides[t]&&(i.x=this.frameOverrides[t].x,i.y=this.frameOverrides[t].y),this.anchorOverrides[t]&&(i.anchor={...this.anchorOverrides[t]})}),this.renderMain(),this.renderOverlays(),this.updateJSON(e),this.previewCanvas.width=e.globalWidth,this.previewCanvas.height=e.globalHeight}handleCanvasClick(e){if(!this.image)return;const i=this.mainCanvas.getBoundingClientRect(),t=e.clientX-i.left,s=e.clientY-i.top,a=this.frames.findIndex(n=>t>=n.x&&t<n.x+n.w&&s>=n.y&&s<n.y+n.h);if(a!==-1){const n=this.frames[a];this.anchorOverrides[a]={x:t-n.x,y:s-n.y},this.update()}}handleHandleMouseDown(e,i){this.draggingFrame=i,this.dragStartMouse={x:e.clientX,y:e.clientY},this.dragStartAnchor={...this.frames[i].anchor},this.dragStartFramePos={x:this.frames[i].x,y:this.frames[i].y}}handleGlobalMouseMove(e){if(this.draggingFrame!==null){const i=e.clientX-this.dragStartMouse.x,t=e.clientY-this.dragStartMouse.y;e.shiftKey||this.interactionMode&&this.interactionMode.value==="anchor"?this.anchorOverrides[this.draggingFrame]={x:this.dragStartAnchor.x+i,y:this.dragStartAnchor.y+t}:this.frameOverrides[this.draggingFrame]={x:this.dragStartFramePos.x+i,y:this.dragStartFramePos.y+t},this.update()}}handleGlobalMouseUp(){this.draggingFrame=null}renderOverlays(){this.overlayLayer.innerHTML="",this.frames.forEach((e,i)=>{const t=document.createElement("div");t.textContent=i,t.style.position="absolute",t.style.left=e.x+e.anchor.x+"px",t.style.top=e.y+e.anchor.y+"px",t.style.transform="translate(-50%, -50%)",t.style.width="20px",t.style.height="20px",t.style.backgroundColor="rgba(0, 255, 0, 0.7)",t.style.color="white",t.style.display="flex",t.style.alignItems="center",t.style.justifyContent="center",t.style.borderRadius="50%",t.style.fontSize="10px",t.style.cursor="move",t.style.pointerEvents="auto",t.style.userSelect="none",this.draggingFrame===i&&(t.style.backgroundColor="rgba(255, 255, 0, 0.9)",t.style.color="black",t.style.border="2px solid white",t.style.zIndex="100"),t.addEventListener("mousedown",s=>{s.stopPropagation(),this.handleHandleMouseDown(s,i)}),t.addEventListener("touchstart",s=>{s.touches.length===1&&(s.stopPropagation(),this.handleHandleMouseDown(s.touches[0],i),s.preventDefault())},{passive:!1}),this.overlayLayer.appendChild(t)})}renderMain(){this.ctx.clearRect(0,0,this.mainCanvas.width,this.mainCanvas.height),this.image&&this.ctx.drawImage(this.image,0,0),this.ctx.lineWidth=1,this.frames.forEach((e,i)=>{this.ctx.strokeStyle="#00ff00",this.ctx.strokeRect(e.x,e.y,e.w,e.h);const t=e.x+e.anchor.x,s=e.y+e.anchor.y;this.ctx.strokeStyle="#ff0000",this.ctx.beginPath(),this.ctx.moveTo(t-10,s),this.ctx.lineTo(t+10,s),this.ctx.moveTo(t,s-10),this.ctx.lineTo(t,s+10),this.ctx.stroke()})}updateJSON(e){let i={sourceFilename:this.sourceFilename,frameWidth:e.frameWidth,frameHeight:e.frameHeight};if(this.image){i.columns=Math.floor(this.image.width/e.frameWidth),i.rows=Math.floor(this.image.height/e.frameHeight);const t=Math.floor(e.startY/e.frameHeight);i.animations={sample_animation:{row:t,frames:e.frameCount}}}else i.frames=this.frames;this.jsonOutput.value=JSON.stringify(i,null,2)}exportSpriteSheet(){if(!this.image||this.frames.length===0)return;const e=this.getConfig(),i=document.createElement("canvas");i.width=e.globalWidth*this.frames.length,i.height=e.globalHeight;const t=i.getContext("2d");if(this.frames.forEach((r,d)=>{const o=d*e.globalWidth+e.globalWidth/2-r.anchor.x,l=e.globalHeight/2-r.anchor.y;t.drawImage(this.image,r.x,r.y,r.w,r.h,o,l,r.w,r.h)}),this.bgRemoveEnabled.checked){const r=t.getImageData(0,0,i.width,i.height);v.process(r,this.bgKeyColor.value,parseInt(this.bgThreshold.value)),v.erode(r,parseInt(this.bgErode.value)),t.putImageData(r,0,0)}const s=document.createElement("a");s.download="aligned_spritesheet.png",s.href=i.toDataURL("image/png"),s.click();const a={sourceFilename:this.sourceFilename,frameWidth:e.globalWidth,frameHeight:e.globalHeight,columns:this.frames.length,rows:1,animations:{animation:{row:0,frames:this.frames.length}}},n=document.createElement("a");n.download="aligned_spritesheet.json";const h=new Blob([JSON.stringify(a,null,2)],{type:"application/json"});n.href=URL.createObjectURL(h),n.click()}saveProject(){const e=this.getProjectState(),i=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),t=document.createElement("a");t.download="frame-tool-project.json",t.href=URL.createObjectURL(i),t.click()}handleLoadProject(e){const i=e.target.files[0];if(!i)return;const t=new FileReader;t.onload=s=>{try{const a=JSON.parse(s.target.result);this.loadProjectState(a)}catch(a){console.error("Failed to load project:",a),alert("Invalid project file")}},t.readAsText(i)}animate(e){if(this.image&&this.frames.length>0){const t=1e3/this.getConfig().fps;e-this.lastFrameTime>t&&(this.currentFrameIndex=(this.currentFrameIndex+1)%this.frames.length,this.lastFrameTime=e,this.renderPreview())}requestAnimationFrame(i=>this.animate(i))}renderPreview(){const e=this.frames[this.currentFrameIndex];if(!e)return;const i=this.getConfig();this.previewCtx.clearRect(0,0,this.previewCanvas.width,this.previewCanvas.height);const t=i.globalWidth/2-e.anchor.x,s=i.globalHeight/2-e.anchor.y;if(this.previewCtx.strokeStyle="rgba(255, 255, 255, 0.2)",this.previewCtx.beginPath(),this.previewCtx.moveTo(i.globalWidth/2,0),this.previewCtx.lineTo(i.globalWidth/2,i.globalHeight),this.previewCtx.moveTo(0,i.globalHeight/2),this.previewCtx.lineTo(i.globalWidth,i.globalHeight/2),this.previewCtx.stroke(),this.previewCtx.drawImage(this.image,e.x,e.y,e.w,e.h,t,s,e.w,e.h),this.bgRemoveEnabled.checked){const a=this.previewCtx.getImageData(t,s,e.w,e.h);v.process(a,this.bgKeyColor.value,parseInt(this.bgThreshold.value)),v.erode(a,parseInt(this.bgErode.value)),this.previewCtx.putImageData(a,t,s)}this.previewCtx.fillStyle="rgba(0, 0, 0, 0.5)",this.previewCtx.fillRect(0,0,20,15),this.previewCtx.fillStyle="white",this.previewCtx.font="10px sans-serif",this.previewCtx.fillText(this.currentFrameIndex,2,11)}}new y;
