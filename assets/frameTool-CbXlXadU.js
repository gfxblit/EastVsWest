import"./modulepreload-polyfill-B5Qt9EMX.js";class f{calculateFrames(t){const s=parseInt(t.startX,10),e=parseInt(t.startY,10),i=parseInt(t.frameWidth,10),a=parseInt(t.frameHeight,10),r=parseInt(t.frameCount,10),o=[];for(let n=0;n<r;n++)o.push({x:s+n*i,y:e,w:i,h:a,anchor:{x:i/2,y:a/2}});return o}}class p{static hexToRgb(t){const s=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return s?{r:parseInt(s[1],16),g:parseInt(s[2],16),b:parseInt(s[3],16)}:null}static process(t,s,e){const i=this.hexToRgb(s);if(!i)return;const a=t.data,{r,g:o,b:n}=i,l=e*e;for(let h=0;h<a.length;h+=4){const d=a[h],v=a[h+1],y=a[h+2],c=d-r,m=v-o,u=y-n;c*c+m*m+u*u<=l&&(a[h+3]=0)}}}class x{constructor(){this.calculator=new f,this.image=null,this.frames=[],this.currentFrameIndex=0,this.lastFrameTime=0,this.animationId=null,this.imageInput=document.getElementById("imageInput"),this.inputs={startX:document.getElementById("startX"),startY:document.getElementById("startY"),frameWidth:document.getElementById("frameWidth"),frameHeight:document.getElementById("frameHeight"),frameCount:document.getElementById("frameCount"),fps:document.getElementById("fps"),globalWidth:document.getElementById("globalWidth"),globalHeight:document.getElementById("globalHeight")},this.bgRemoveEnabled=document.getElementById("bgRemoveEnabled"),this.bgRemoveControls=document.getElementById("bgRemoveControls"),this.bgKeyColor=document.getElementById("bgKeyColor"),this.bgKeyColorText=document.getElementById("bgKeyColorText"),this.bgThreshold=document.getElementById("bgThreshold"),this.bgThresholdVal=document.getElementById("bgThresholdVal"),this.exportBtn=document.getElementById("exportBtn"),this.mainCanvas=document.getElementById("mainCanvas"),this.previewCanvas=document.getElementById("previewCanvas"),this.jsonOutput=document.getElementById("jsonOutput"),this.dropZone=document.getElementById("dropZone"),this.overlayLayer=document.getElementById("overlayLayer"),this.ctx=this.mainCanvas.getContext("2d"),this.previewCtx=this.previewCanvas.getContext("2d"),this.anchorOverrides={},this.frameOverrides={},this.draggingFrame=null,this.dragStartMouse={x:0,y:0},this.dragStartAnchor={x:0,y:0},this.dragStartFramePos={x:0,y:0},this.init()}init(){this.imageInput.addEventListener("change",t=>this.handleFileSelect(t.target.files[0])),Object.values(this.inputs).forEach(t=>{t.addEventListener("input",()=>this.update())}),this.bgRemoveEnabled.addEventListener("change",()=>{this.bgRemoveControls.style.display=this.bgRemoveEnabled.checked?"flex":"none",this.renderPreview()}),this.bgKeyColor.addEventListener("input",t=>{this.bgKeyColorText.value=t.target.value,this.renderPreview()}),this.bgKeyColorText.addEventListener("input",t=>{this.bgKeyColor.value=t.target.value,this.renderPreview()}),this.bgThreshold.addEventListener("input",t=>{this.bgThresholdVal.textContent=t.target.value,this.renderPreview()}),this.exportBtn.addEventListener("click",()=>this.exportSpriteSheet()),this.mainCanvas.addEventListener("mousedown",t=>this.handleCanvasClick(t)),window.addEventListener("mousemove",t=>this.handleGlobalMouseMove(t)),window.addEventListener("mouseup",()=>this.handleGlobalMouseUp()),this.dropZone.addEventListener("dragover",t=>{t.preventDefault(),this.dropZone.style.backgroundColor="#333"}),this.dropZone.addEventListener("dragleave",t=>{t.preventDefault(),this.dropZone.style.backgroundColor="#222"}),this.dropZone.addEventListener("drop",t=>{t.preventDefault(),this.dropZone.style.backgroundColor="#222",t.dataTransfer.files.length>0&&this.handleFileSelect(t.dataTransfer.files[0])}),this.animate(0)}handleFileSelect(t){if(!t||!t.type.startsWith("image/"))return;const s=new FileReader;s.onload=e=>{const i=new Image;i.onload=()=>{this.image=i,this.mainCanvas.width=i.width,this.mainCanvas.height=i.height,this.overlayLayer.style.width=i.width+"px",this.overlayLayer.style.height=i.height+"px",this.update()},i.src=e.target.result},s.readAsDataURL(t)}getConfig(){return{startX:parseInt(this.inputs.startX.value)||0,startY:parseInt(this.inputs.startY.value)||0,frameWidth:parseInt(this.inputs.frameWidth.value)||32,frameHeight:parseInt(this.inputs.frameHeight.value)||32,frameCount:parseInt(this.inputs.frameCount.value)||1,fps:parseInt(this.inputs.fps.value)||10,globalWidth:parseInt(this.inputs.globalWidth.value)||64,globalHeight:parseInt(this.inputs.globalHeight.value)||64}}update(){const t=this.getConfig();this.frames=this.calculator.calculateFrames(t),this.frames.forEach((s,e)=>{this.frameOverrides[e]&&(s.x=this.frameOverrides[e].x,s.y=this.frameOverrides[e].y),this.anchorOverrides[e]&&(s.anchor={...this.anchorOverrides[e]})}),this.renderMain(),this.renderOverlays(),this.updateJSON(t),this.previewCanvas.width=t.globalWidth,this.previewCanvas.height=t.globalHeight}handleCanvasClick(t){if(!this.image)return;const s=this.mainCanvas.getBoundingClientRect(),e=t.clientX-s.left,i=t.clientY-s.top,a=this.frames.findIndex(r=>e>=r.x&&e<r.x+r.w&&i>=r.y&&i<r.y+r.h);if(a!==-1){const r=this.frames[a];this.anchorOverrides[a]={x:e-r.x,y:i-r.y},this.update()}}handleHandleMouseDown(t,s){t.stopPropagation(),this.draggingFrame=s,this.dragStartMouse={x:t.clientX,y:t.clientY},this.dragStartAnchor={...this.frames[s].anchor},this.dragStartFramePos={x:this.frames[s].x,y:this.frames[s].y}}handleGlobalMouseMove(t){if(this.draggingFrame!==null){const s=t.clientX-this.dragStartMouse.x,e=t.clientY-this.dragStartMouse.y;t.shiftKey?this.anchorOverrides[this.draggingFrame]={x:this.dragStartAnchor.x+s,y:this.dragStartAnchor.y+e}:this.frameOverrides[this.draggingFrame]={x:this.dragStartFramePos.x+s,y:this.dragStartFramePos.y+e},this.update()}}handleGlobalMouseUp(){this.draggingFrame=null}renderOverlays(){this.overlayLayer.innerHTML="",this.frames.forEach((t,s)=>{const e=document.createElement("div");e.textContent=s,e.style.position="absolute",e.style.left=t.x+t.anchor.x+"px",e.style.top=t.y+t.anchor.y+"px",e.style.transform="translate(-50%, -50%)",e.style.width="20px",e.style.height="20px",e.style.backgroundColor="rgba(0, 255, 0, 0.7)",e.style.color="white",e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="center",e.style.borderRadius="50%",e.style.fontSize="10px",e.style.cursor="move",e.style.pointerEvents="auto",e.style.userSelect="none",this.draggingFrame===s&&(e.style.backgroundColor="rgba(255, 255, 0, 0.9)",e.style.color="black",e.style.border="2px solid white",e.style.zIndex="100"),e.addEventListener("mousedown",i=>this.handleHandleMouseDown(i,s)),this.overlayLayer.appendChild(e)})}renderMain(){this.ctx.clearRect(0,0,this.mainCanvas.width,this.mainCanvas.height),this.image&&this.ctx.drawImage(this.image,0,0),this.ctx.lineWidth=1,this.frames.forEach((t,s)=>{this.ctx.strokeStyle="#00ff00",this.ctx.strokeRect(t.x,t.y,t.w,t.h);const e=t.x+t.anchor.x,i=t.y+t.anchor.y;this.ctx.strokeStyle="#ff0000",this.ctx.beginPath(),this.ctx.moveTo(e-10,i),this.ctx.lineTo(e+10,i),this.ctx.moveTo(e,i-10),this.ctx.lineTo(e,i+10),this.ctx.stroke()})}updateJSON(t){let s={frameWidth:t.frameWidth,frameHeight:t.frameHeight};if(this.image){s.columns=Math.floor(this.image.width/t.frameWidth),s.rows=Math.floor(this.image.height/t.frameHeight);const e=Math.floor(t.startY/t.frameHeight);s.animations={sample_animation:{row:e,frames:t.frameCount}}}else s.frames=this.frames;this.jsonOutput.value=JSON.stringify(s,null,2)}exportSpriteSheet(){if(!this.image||this.frames.length===0)return;const t=this.getConfig(),s=document.createElement("canvas");s.width=t.globalWidth*this.frames.length,s.height=t.globalHeight;const e=s.getContext("2d");if(this.frames.forEach((n,l)=>{const h=l*t.globalWidth+t.globalWidth/2-n.anchor.x,d=t.globalHeight/2-n.anchor.y;e.drawImage(this.image,n.x,n.y,n.w,n.h,h,d,n.w,n.h)}),this.bgRemoveEnabled.checked){const n=e.getImageData(0,0,s.width,s.height);p.process(n,this.bgKeyColor.value,parseInt(this.bgThreshold.value)),e.putImageData(n,0,0)}const i=document.createElement("a");i.download="aligned_spritesheet.png",i.href=s.toDataURL("image/png"),i.click();const a={frameWidth:t.globalWidth,frameHeight:t.globalHeight,columns:this.frames.length,rows:1,animations:{animation:{row:0,frames:this.frames.length}}},r=document.createElement("a");r.download="aligned_spritesheet.json";const o=new Blob([JSON.stringify(a,null,2)],{type:"application/json"});r.href=URL.createObjectURL(o),r.click()}animate(t){if(this.image&&this.frames.length>0){const e=1e3/this.getConfig().fps;t-this.lastFrameTime>e&&(this.currentFrameIndex=(this.currentFrameIndex+1)%this.frames.length,this.lastFrameTime=t,this.renderPreview())}requestAnimationFrame(s=>this.animate(s))}renderPreview(){const t=this.frames[this.currentFrameIndex];if(!t)return;const s=this.getConfig();this.previewCtx.clearRect(0,0,this.previewCanvas.width,this.previewCanvas.height);const e=s.globalWidth/2-t.anchor.x,i=s.globalHeight/2-t.anchor.y;if(this.previewCtx.strokeStyle="rgba(255, 255, 255, 0.2)",this.previewCtx.beginPath(),this.previewCtx.moveTo(s.globalWidth/2,0),this.previewCtx.lineTo(s.globalWidth/2,s.globalHeight),this.previewCtx.moveTo(0,s.globalHeight/2),this.previewCtx.lineTo(s.globalWidth,s.globalHeight/2),this.previewCtx.stroke(),this.previewCtx.drawImage(this.image,t.x,t.y,t.w,t.h,e,i,t.w,t.h),this.bgRemoveEnabled.checked){const a=this.previewCtx.getImageData(e,i,t.w,t.h);p.process(a,this.bgKeyColor.value,parseInt(this.bgThreshold.value)),this.previewCtx.putImageData(a,e,i)}this.previewCtx.fillStyle="rgba(0, 0, 0, 0.5)",this.previewCtx.fillRect(0,0,20,15),this.previewCtx.fillStyle="white",this.previewCtx.font="10px sans-serif",this.previewCtx.fillText(this.currentFrameIndex,2,11)}}new x;
