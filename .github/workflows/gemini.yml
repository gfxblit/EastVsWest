name: Gemini

on:
  issue_comment:
    types: [created]

jobs:
  gemini:
    if: github.event.issue.pull_request && contains(fromJSON('["OWNER", "MEMBER", "COLLABORATOR", "CONTRIBUTOR"]'), github.event.comment.author_association) && contains(github.event.comment.body, '@gemini resolve')
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: write
      pull-requests: write
      id-token: write
      actions: read
    steps:
      - name: Mint identity token
        id: mint_identity_token
        if: ${{ vars.APP_ID }}
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          permission-contents: write
          permission-issues: write
          permission-pull-requests: write

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Cache Supabase Docker Images
        id: cache-supabase
        uses: actions/cache@v4
        with:
          path: /tmp/supabase-images.tar
          key: ${{ runner.os }}-supabase-images-${{ hashFiles('supabase/config.toml') }}

      - name: Load Supabase Docker Images
        if: steps.cache-supabase.outputs.cache-hit == 'true'
        run: docker load -i /tmp/supabase-images.tar

      - name: Start Supabase
        run: |
          supabase start --exclude studio,storage-api,imgproxy,mailpit,edge-runtime,logflare,vector,supavisor,postgres-meta

      - name: Export Supabase credentials
        run: |
          STATUS=$(supabase status -o json)
          echo "SUPABASE_URL=$(echo $STATUS | jq -r '.api_url')" >> $GITHUB_ENV
          echo "SUPABASE_ANON_KEY=$(echo $STATUS | jq -r '.anon_key')" >> $GITHUB_ENV

      - name: Save Supabase Docker Images
        if: steps.cache-supabase.outputs.cache-hit != 'true'
        run: |
          docker save $(docker ps --format '{{.Image}}' | sort -u) -o /tmp/supabase-images.tar

      - name: Inject Gemini Credentials
        env:
          GEMINI_SETTINGS_JSON: ${{ secrets.GEMINI_SETTINGS_JSON }}
          GEMINI_OAUTH_CREDS_JSON: ${{ secrets.GEMINI_OAUTH_CREDS_JSON }}
        run: |
          if [ -n "$GEMINI_SETTINGS_JSON" ] && [ -n "$GEMINI_OAUTH_CREDS_JSON" ]; then
            mkdir -p ~/.gemini
            printf '%s' "$GEMINI_SETTINGS_JSON" > ~/.gemini/settings.json
            printf '%s' "$GEMINI_OAUTH_CREDS_JSON" > ~/.gemini/oauth_creds.json
            echo "Successfully injected Gemini credentials into ~/.gemini/"
          else
            echo "::warning::GEMINI_SETTINGS_JSON or GEMINI_OAUTH_CREDS_JSON secrets are missing. Falling back to API key configuration."
          fi

      - name: Extract prompt
        id: extract_prompt
        uses: actions/github-script@v7
        with:
          script: |
            const c = context.payload.comment;
            const repo = context.repo;
            const issue_number = context.payload.issue.number;

            const discussionContext = "### Conversation Thread\n\n**@" + c.user.login + "**: " + c.body;

            core.setOutput('prompt', 'Your task is to resolve all open issues and feedback in this Pull Request. Analyze the PR description, the code changes, and the conversation thread to identify what needs to be fixed or improved, then implement the changes.');
            core.setOutput('discussion_context', discussionContext);
            core.setOutput('trigger_comment_id', c.id);
            core.setOutput('root_comment_id', c.id);
            core.setOutput('review_threads', JSON.stringify([{ id: c.id, body: c.body }]));

      - name: Acknowledge request
        id: acknowledge
        env:
          GITHUB_TOKEN: ${{ steps.mint_identity_token.outputs.token || secrets.GITHUB_TOKEN || github.token }}
          PR_NUMBER: ${{ github.event.issue.number }}
          MESSAGE: |-
            ðŸ¤– Hi @${{ github.actor }}, I've received your request and I'm on it! You can track my progress [in the logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}).
          REPOSITORY: ${{ github.repository }}
          TRIGGER_COMMENT_ID: ${{ steps.extract_prompt.outputs.trigger_comment_id }}
        run: |
          COMMENT_ID=$(gh api -X POST "/repos/${REPOSITORY}/issues/${PR_NUMBER}/comments" \
            -f body="${MESSAGE}" \
            --jq '.id')
          echo "comment_id=$COMMENT_ID" >> $GITHUB_OUTPUT
          echo "GEMINI_COMMENT_ID=$COMMENT_ID" >> $GITHUB_ENV
          echo "comment_type=issue" >> $GITHUB_OUTPUT
          echo "GEMINI_COMMENT_TYPE=issue" >> $GITHUB_ENV

      - name: Set Gemini prompt
        run: |
          echo "GEMINI_PROMPT<<EOF" >> $GITHUB_ENV
          cat << 'PROMPT_CONTENT' >> $GITHUB_ENV
          You are Gemini, an AI assistant designed to help with pull requests. Think carefully as you analyze the context and respond appropriately. Here's the context for your current task:

          <formatted_context>
          PR Title: ${{ github.event.issue.title }}
          PR Author: ${{ github.event.issue.user.login }}
          PR State: ${{ github.event.issue.state }}
          PR Body:
          ${{ github.event.issue.body }}
          </formatted_context>

          <pr_comment_body>
          ${{ steps.extract_prompt.outputs.prompt }}
          </pr_comment_body>

          <comments>
          ${{ steps.extract_prompt.outputs.discussion_context }}
          </comments>

          <event_type>${{ github.event_name }}</event_type>
          <repository>${{ github.repository }}</repository>

          <pr_number>${{ github.event.issue.number }}</pr_number>
          <gemini_comment_id>${{ steps.acknowledge.outputs.comment_id }}</gemini_comment_id>
          <gemini_comment_type>${{ steps.acknowledge.outputs.comment_type }}</gemini_comment_type>
          <trigger_comment_id>${{ steps.extract_prompt.outputs.trigger_comment_id }}</trigger_comment_id>
          <review_threads>${{ steps.extract_prompt.outputs.review_threads }}</review_threads>
          <trigger_username>${{ github.actor }}</trigger_username>
          <trigger_display_name>${{ github.actor }}</trigger_display_name>
          <trigger_phrase>@gemini</trigger_phrase>

          <comment_tool_info>
          IMPORTANT: Use the `run_shell_command` tool to execute `gh api` and update your progress comment.

          ALWAYS update the single comment thread where you were triggered.

          Your progress comment ID is: ${{ steps.acknowledge.outputs.comment_id }}
          The type of your comment is: ${{ steps.acknowledge.outputs.comment_type }}

          To update your comment body robustly (always include the View job run link):
          printf '%s' 'Your updated Markdown text with job run link' | gh api -X PATCH /repos/${{ github.repository }}/${{ steps.acknowledge.outputs.comment_type == 'pull' && 'pulls' || 'issues' }}/comments/${{ steps.acknowledge.outputs.comment_id }} --input -

          CRITICAL: You are already on the correct branch. DO NOT spend time finding branch names or constructing PR URLs. Focus exclusively on the code changes or questions.
          </comment_tool_info>

                    Your task is to analyze the context, understand the request, and provide helpful responses and/or implement code changes as needed.
          
                    Follow these steps:
          1. Create a Todo List:
             - IMMEDIATELY update your GitHub comment with a task list.
             - Format: ### Tasks\n- [ ] Task 1\n- [ ] Task 2\n...
             - Use the spinner: <img src="https://github.com/user-attachments/assets/5ac382c7-e004-429b-8e35-7feb3e8f9c6f" width="14px" height="14px" style="vertical-align: middle; margin-left: 4px;" />

          2. Understand and Execute:
             - Implement changes or answer questions.
             - Update the comment as you finish each task.
             - For code changes: `git add <files>`, `git commit -m "<message>\n\nCo-authored-by: ${{ github.actor }} <${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com>"`, `git push origin HEAD`

          3. Final Summary:
             - Remove the spinner and post a final summary in the same comment using `gh api`.
             - **MANDATORY**: You MUST execute the `gh api` command to make this summary visible. Just generating the text is not enough.
             - Always include: [View job run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          Important Notes:
          - **CRITICAL**: Your standard text output is NOT posted to GitHub. The user will NOT see anything you write unless you explicitly use the `gh api` command to update the comment.
          - **ALWAYS** ends your execution by updating the comment one last time with the final result.
          - Communicate ONLY by updating your single acknowledgement comment (ID: ${{ steps.acknowledge.outputs.comment_id }}).
          - REPOSITORY SETUP: Follow GEMINI.md for repo-specific setup and standards.
          PROMPT_CONTENT
          echo "EOF" >> $GITHUB_ENV

      - name: Run Gemini CLI (gemini-3-flash-preview)
        uses: google-github-actions/run-gemini-cli@v0.1.18
        id: gemini_3_flash
        continue-on-error: true
        env:
          GEMINI_COMMENT_ID: ${{ env.GEMINI_COMMENT_ID }}
          GEMINI_COMMENT_TYPE: ${{ env.GEMINI_COMMENT_TYPE }}
          PR_NUMBER: ${{ github.event.issue.number }}
          GITHUB_TOKEN: ${{ steps.mint_identity_token.outputs.token || secrets.GITHUB_TOKEN || github.token }}
          SUPABASE_URL: ${{ env.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ env.SUPABASE_ANON_KEY }}
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          gemini_model: 'gemini-3-flash-preview'
          gemini_cli_version: '${{ vars.GEMINI_CLI_VERSION }}'
          gemini_debug: true
          upload_artifacts: '${{ vars.UPLOAD_ARTIFACTS }}'
          workflow_name: 'gemini'
          prompt: ${{ env.GEMINI_PROMPT }}
          settings: |-
            {
              "model": {
                "maxSessionTurns": 50
              },
              "telemetry": {
                "enabled": false,
                "target": "local",
                "outfile": ".gemini/telemetry.log"
              },
              "mcpServers": {
                "github": {
                  "command": "docker",
                  "args": [
                    "run",
                    "-i",
                    "--rm",
                    "-e",
                    "GITHUB_PERSONAL_ACCESS_TOKEN",
                    "ghcr.io/github/github-mcp-server:v0.18.0"
                  ],
                  "includeTools": [
                    "add_comment_to_pending_review",
                    "create_pending_pull_request_review",
                    "pull_request_read",
                    "submit_pending_pull_request_review"
                  ],
                  "env": {
                    "GITHUB_PERSONAL_ACCESS_TOKEN": "${GITHUB_TOKEN}"
                  }
                }
              },
              "tools": {
                "core": [
                  "run_shell_command(bash)",
                  "run_shell_command(cat)",
                  "run_shell_command(echo)",
                  "run_shell_command(env)",
                  "run_shell_command(gh)",
                  "run_shell_command(git)",
                  "run_shell_command(grep)",
                  "run_shell_command(head)",
                  "run_shell_command(ls)",
                  "run_shell_command(node)",
                  "run_shell_command(npm)",
                  "run_shell_command(npx)",
                  "run_shell_command(printf)",
                  "run_shell_command(sh)",
                  "run_shell_command(supabase)",
                  "run_shell_command(tail)"
                ]
              }
            }

      - name: Run Gemini CLI (gemini-2.5-pro)
        if: steps.gemini_3_flash.outcome != 'success'
        uses: google-github-actions/run-gemini-cli@v0.1.18
        id: gemini_2_5_pro
        continue-on-error: true
        env:
          GEMINI_COMMENT_ID: ${{ env.GEMINI_COMMENT_ID }}
          GEMINI_COMMENT_TYPE: ${{ env.GEMINI_COMMENT_TYPE }}
          PR_NUMBER: ${{ github.event.issue.number }}
          GITHUB_TOKEN: ${{ steps.mint_identity_token.outputs.token || secrets.GITHUB_TOKEN || github.token }}
          SUPABASE_URL: ${{ env.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ env.SUPABASE_ANON_KEY }}
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          gemini_model: 'gemini-2.5-pro'
          gemini_cli_version: '${{ vars.GEMINI_CLI_VERSION }}'
          gemini_debug: true
          upload_artifacts: '${{ vars.UPLOAD_ARTIFACTS }}'
          workflow_name: 'gemini'
          prompt: ${{ env.GEMINI_PROMPT }}
          settings: |-
            {
              "model": {
                "maxSessionTurns": 50
              },
              "telemetry": {
                "enabled": false,
                "target": "local",
                "outfile": ".gemini/telemetry.log"
              },
              "mcpServers": {
                "github": {
                  "command": "docker",
                  "args": [
                    "run",
                    "-i",
                    "--rm",
                    "-e",
                    "GITHUB_PERSONAL_ACCESS_TOKEN",
                    "ghcr.io/github/github-mcp-server:v0.18.0"
                  ],
                  "includeTools": [
                    "add_comment_to_pending_review",
                    "create_pending_pull_request_review",
                    "pull_request_read",
                    "submit_pending_pull_request_review"
                  ],
                  "env": {
                    "GITHUB_PERSONAL_ACCESS_TOKEN": "${GITHUB_TOKEN}"
                  }
                }
              },
              "tools": {
                "core": [
                  "run_shell_command(bash)",
                  "run_shell_command(cat)",
                  "run_shell_command(echo)",
                  "run_shell_command(env)",
                  "run_shell_command(gh)",
                  "run_shell_command(git)",
                  "run_shell_command(grep)",
                  "run_shell_command(head)",
                  "run_shell_command(ls)",
                  "run_shell_command(node)",
                  "run_shell_command(npm)",
                  "run_shell_command(npx)",
                  "run_shell_command(printf)",
                  "run_shell_command(sh)",
                  "run_shell_command(supabase)",
                  "run_shell_command(tail)"
                ]
              }
            }

      - name: Run Gemini CLI (gemini-2.5-flash)
        if: steps.gemini_3_flash.outcome != 'success' && steps.gemini_2_5_pro.outcome != 'success'
        uses: google-github-actions/run-gemini-cli@v0.1.18
        id: gemini_2_5_flash
        env:
          GEMINI_COMMENT_ID: ${{ env.GEMINI_COMMENT_ID }}
          GEMINI_COMMENT_TYPE: ${{ env.GEMINI_COMMENT_TYPE }}
          PR_NUMBER: ${{ github.event.issue.number }}
          GITHUB_TOKEN: ${{ steps.mint_identity_token.outputs.token || secrets.GITHUB_TOKEN || github.token }}
          SUPABASE_URL: ${{ env.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ env.SUPABASE_ANON_KEY }}
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          gemini_model: 'gemini-2.5-flash'
          gemini_cli_version: '${{ vars.GEMINI_CLI_VERSION }}'
          gemini_debug: true
          upload_artifacts: '${{ vars.UPLOAD_ARTIFACTS }}'
          workflow_name: 'gemini'
          prompt: ${{ env.GEMINI_PROMPT }}
          settings: |-
            {
              "model": {
                "maxSessionTurns": 50
              },
              "telemetry": {
                "enabled": false,
                "target": "local",
                "outfile": ".gemini/telemetry.log"
              },
              "mcpServers": {
                "github": {
                  "command": "docker",
                  "args": [
                    "run",
                    "-i",
                    "--rm",
                    "-e",
                    "GITHUB_PERSONAL_ACCESS_TOKEN",
                    "ghcr.io/github/github-mcp-server:v0.18.0"
                  ],
                  "includeTools": [
                    "add_comment_to_pending_review",
                    "create_pending_pull_request_review",
                    "pull_request_read",
                    "submit_pending_pull_request_review"
                  ],
                  "env": {
                    "GITHUB_PERSONAL_ACCESS_TOKEN": "${GITHUB_TOKEN}"
                  }
                }
              },
              "tools": {
                "core": [
                  "run_shell_command(bash)",
                  "run_shell_command(cat)",
                  "run_shell_command(echo)",
                  "run_shell_command(env)",
                  "run_shell_command(gh)",
                  "run_shell_command(git)",
                  "run_shell_command(grep)",
                  "run_shell_command(head)",
                  "run_shell_command(ls)",
                  "run_shell_command(node)",
                  "run_shell_command(npm)",
                  "run_shell_command(npx)",
                  "run_shell_command(printf)",
                  "run_shell_command(sh)",
                  "run_shell_command(supabase)",
                  "run_shell_command(tail)"
                ]
              }
            }

      - name: Expose Gemini Error Reports
        if: failure()
        run: |
          echo "Checking for Gemini error reports in /tmp..."
          REPORTS=$(find /tmp -name "geminient-error-*.json" 2>/dev/null || true)
          if [ -n "$REPORTS" ]; then
            for report in $REPORTS;
            do
              echo "::group::Error Report: $report"
              cat "$report"
              echo "::endgroup::"
            done
          else
            echo "No Gemini error reports found in /tmp."
          fi

      - name: Post failure comment
        if: always() && (failure() || cancelled())
        env:
          GITHUB_TOKEN: ${{ steps.mint_identity_token.outputs.token || secrets.GITHUB_TOKEN || github.token }}
          PR_NUMBER: ${{ github.event.issue.number }}
          REPOSITORY: ${{ github.repository }}
          TRIGGER_COMMENT_ID: ${{ steps.extract_prompt.outputs.trigger_comment_id }}
        run: |
          MESSAGE="ðŸ¤– I'm sorry @${{ github.actor }}, but I was unable to process your request. Please [see the logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for more details."
          gh api -X POST "/repos/${REPOSITORY}/issues/${PR_NUMBER}/comments" \
            -f body="${MESSAGE}"
